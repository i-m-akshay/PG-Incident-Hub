<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG Incident Management</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            color: #2d3748;
        }
        .incident-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border-left: 6px solid;
        }
        .incident-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15);
        }
        .email-button {
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        }
        .email-button:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .copy-btn {
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        }
        .copy-btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .search-icon {
            filter: grayscale(100%);
            transition: filter 0.2s, color 0.2s;
        }
        .search-icon:hover {
            filter: grayscale(0%);
            color: #3b82f6;
        }
        .category-card-button {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid;
        }
        .category-card-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
            animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse {
            0%, 100% {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
            }
            50% {
                transform: translateY(-8px);
                box-shadow: 0 15px 20px rgba(0, 0, 0, 0.2);
            }
        }
        .caret-icon {
            transition: transform 0.3s ease;
        }
        .caret-icon.rotate {
            transform: rotate(90deg);
        }
        /* New styles for highlighting and fading */
        .faded-category {
            opacity: 0.6;
        }
        .highlighted-category {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
            border: 2px solid #3b82f6;
            animation: none;
        }
        .highlighted-category:hover {
             transform: translateY(-5px); /* Maintain the lift */
        }
        .search-loading {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
        }
        .search-loading svg {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scroll to bottom button styling */
        #scrollToBottomBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease;
            z-index: 100;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header section with title and search bar -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-bold text-gray-800 mb-2">PG Incident Hub</h1>
            <p class="text-gray-500 text-lg">Your one-stop guide for handling all types of incidents.</p>
        </header>

        <!-- Search bar -->
        <div class="mb-10 flex justify-center">
            <div class="relative w-full max-w-2xl">
                <input type="text" id="incidentSearch" placeholder="Smart Search..." class="w-full pl-12 pr-4 py-3 rounded-full border-2 border-gray-300 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-md text-lg">
                <div id="searchLoading" class="search-loading hidden">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.418 10h.582M18 10c-1.657 0-3-1.343-3-3s1.343-3 3-3 3 1.343 3 3-1.343 3-3 3zm0 0v14" />
                    </svg>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>

        <!-- Incidents container -->
        <div id="incidentsContainer" class="space-y-8">
            <!-- All content will be dynamically generated here by JavaScript -->
        </div>
    </div>

    <!-- Scroll to bottom button -->
    <div id="scrollToBottomBtn" class="hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
        </svg>
    </div>

    <!-- Message box for copy confirmation -->
    <div id="messageBox" class="fixed bottom-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-full transition-all duration-500 z-50">
        Message copied to clipboard!
    </div>

    <script>
        // === START OF EDITABLE SECTION ===
        const incidentsData = [
            {
                category: 'Upsell',
                borderColor: '#48BB78', // Green
                incidents: [
                    {
                        id: 'upsell-tier-completion',
                        title: 'Tier Completion (after session 47)',
                        description: 'When your batch is about to complete TIER (at session number 47)',
                        keywords: ['upsell', 'tier', 'completion', 'session 47', 'batch complete', 'final session'],
                        to: 'LTV Counsellor',
                        toEmails: 'ltvcounselor@example.com',
                        cc: 'LTV alias, Lead , preeti, akansha negi, PM, Roshan',
                        ccEmails: 'ltvalias@example.com,lead@example.com,preeti@example.com,akansha.negi@example.com,pm@example.com,roshan@example.com',
                        draftMessage: `Hi [LTV counselor name],

The [batch ID] batch requires an upsell. There are a total of [no. of students] students in this batch.
Currently, they are in [Tier, Stage, Session]. Please do the needful and let me know if you need any other information.

Best regards,
[PG's Name]`
                    },
                    {
                        id: 'upsell-parent-concern',
                        title: 'Parents\' concern after upsell',
                        description: 'Parent expresses that the child is upsold in the wrong tier, has problems with the curriculum and syllabus. Expectation of the parents is not met in the upsold tier (might come up mid-tier as well), or in case of evaluation',
                        keywords: ['parent', 'concern', 'upsell', 'wrong tier', 'curriculum', 'syllabus', 'evaluation', 'meeting'],
                        to: 'PM, SPM',
                        toEmails: 'pm@example.com,spm@example.com',
                        cc: 'Lead, Anurag, Roshan',
                        ccEmails: 'lead@example.com,anurag@example.com,roshan@example.com',
                        draftMessage: `Hi [PM/SPM name],

The parent of the student [customer ID] [student name] in the batch [batch ID] joined the recent session to inform that [concern in brief with all the important details mentioned by the parent].

Please look into this.

Best regards,
[PG's Name]`
                    },
                    {
                        id: 'upsell-absent-1-2',
                        title: 'Absenteeism in upsell batch (sessions 1-2)',
                        description: 'The student did not join for the first two sessions.',
                        keywords: ['absent', 'absenteeism', 'upsell', 'sessions 1-2', 'missed class'],
                        to: 'Counsellor',
                        toEmails: 'counsellor@example.com',
                        cc: 'Lead, ltv, PM, Roshan',
                        ccEmails: 'lead@example.com,ltv@example.com,pm@example.com,roshan@example.com',
                        draftMessage: `Hi [counselor name],

This is to inform you that student [student ID] [student name] has been absent for 2 consecutive sessions (Sessions 1 and 2) of Tier [Tier, stage].
Can you please look into this and take the necessary steps?
Batch Name: [batch ID]
Student: [student name] [student ID]

Best regards,
[PG's Name]`
                    },
                    {
                        id: 'upsell-absent-1-4',
                        title: 'Absenteeism in upsell batch (sessions 1-4)',
                        description: 'The student did not join for the first four sessions. NOTE: SPM to ask ushma to mark as course completed and inform LTV',
                        keywords: ['absent', 'absenteeism', 'upsell', 'sessions 1-4', 'course completed'],
                        to: 'PM/SPM',
                        toEmails: 'pm@example.com,spm@example.com',
                        cc: 'Lead, ltv, PM, Roshan',
                        ccEmails: 'lead@example.com,ltv@example.com,pm@example.com,roshan@example.com',
                        draftMessage: `Hi [PM/SPM name],

This is to inform you that student [student ID] [student name] has been absent for 4 consecutive sessions (Sessions 1 to 4) of Tier [Tier, stage].
Can you please look into this and take the necessary steps?
Batch Name: [batch ID]
Student: [student name] [student ID]

Best regards,
[PG's Name]`
                    }
                ]
            },
            {
                category: 'Pause related',
                borderColor: '#F87171', // Red
                incidents: [
                    {
                        id: 'pause-related-parent-informed',
                        title: 'Parent informed',
                        description: 'Parents informed in the class that the child will be going on a pause. NOTE: PG should get the info whenever a student joins back after a pause. PG to confirm from the student about the kit (PG to get trained on how to apply for pause on LMS)',
                        keywords: ['pause', 'parent informed', 'break', 'session hold'],
                        to: 'jyoti/akash chaudhary',
                        toEmails: 'jyoti@example.com,akashchaudhary@example.com',
                        cc: 'Lead, cc-team@moonpreneur.com',
                        ccEmails: 'lead@example.com,ccteam@moonpreneur.com',
                        draftMessage: `Hi [Jyoti/Akash],

The parent of the student [customer ID] [student name] in the batch [batch ID] joined the recent session and informed that [mention the reason] [Date from: To]. Please confirm with the parent again and mark the student as paused.

Best regards,
[PG's Name]`
                    }
                ]
            },
            {
                category: 'Student & Parent Issues',
                borderColor: '#60A5FA', // Light Blue
                incidents: [
                    {
                        id: 'fast-slow-pace',
                        title: 'Fast/Slow pace',
                        description: 'When a student is either too fast or too slow in class.',
                        keywords: ['pace', 'fast', 'slow', 'student speed', 'bored', 'frustrated'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Anurag, PM, Lead',
                        ccEmails: 'anurag@example.com,pm@example.com,lead@example.com',
                        draftMessage: `Hi [SPM Name],

I have a student in my [Batch ID] batch, [Student Name] [Student ID], who is either moving too fast or too slow. [Briefly explain the situation: e.g., "The student is completing all the activities very quickly and is bored," or "The student is unable to keep up with the pace of the class and is getting frustrated."]

Can you please look into this and provide some guidance?

Thanks.`
                    },
                    {
                        id: 'student-behavior-issues',
                        title: 'Student Behavior Issues',
                        description: 'If a student does not fit in the batch due to various reasons. Note: SPM to take further action and tag people based on the situation.',
                        keywords: ['behavior', 'student issue', 'disruptive', 'inappropriate language', 'refusing to participate'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Anurag, PM, Lead',
                        ccEmails: 'anurag@example.com,pm@example.com,lead@example.com',
                        draftMessage: `Hi [SPM Name],

This is regarding [Student Name] [Student ID] from batch [Batch ID]. The student is consistently displaying disruptive behavior, such as [describe the behavior in detail, e.g., "using inappropriate language," "refusing to participate," "distracting other students"]. I have tried [mention the steps you have taken, e.g., "speaking with the student privately," "setting clear expectations," "informing the parent in the chat box"].

Can you please intervene and suggest the next steps?

Thanks.`
                    },
                    {
                        id: 'parents-interaction-with-pgs',
                        title: 'Parents\' Interaction with PGs',
                        description: 'The customer says something, and the PG should not reply with answers, but instead let them know that a team will get in touch and set up a separate meeting. After the session, the PG should drop an email. Note: SPM to analyze the situation and decide who all are supposed to be tagged further.',
                        keywords: ['parent', 'interaction', 'meeting', 'team connect', 'separate discussion'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Lead, PM, Anurag',
                        ccEmails: 'lead@example.com,pm@example.com,anurag@example.com',
                        draftMessage: `Hi [SPM Name],

A parent of [Student Name] [Student ID] from my batch [Batch ID] wants to have a discussion with me regarding [briefly state the parent's concern]. I have informed the parent that the team will connect with them.

Please take further action.

Thanks.`
                    },
                    {
                        id: 'parent-requests-ptm',
                        title: 'If the Parent is asking for PTM',
                        description: 'When a parent directly requests a Parent-Teacher Meeting. SPM will tag and align a Counselor or Senior team member as per the requirement.',
                        keywords: ['ptm', 'parent teacher meeting', 'request', 'schedule meeting'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Lead, PM',
                        ccEmails: 'lead@example.com,pm@example.com',
                        draftMessage: `Hi [SPM Name],

A parent from my batch [Batch ID] is asking for a PTM. [Student Name] [Student ID] is facing [mention the parent's concern].

Could you please schedule a meeting with the parent?

Thanks.`
                    },
                    {
                        id: 'parents-direct-email-to-pg',
                        title: 'If the parents write a direct email to PG',
                        description: 'If the email is related to assignments or credentials of the platform, the PG can reply directly after a discussion with the lead, while keeping the Lead and PM in CC. Otherwise, the email should be forwarded.',
                        keywords: ['parent email', 'direct email', 'assignment', 'credentials', 'forward email'],
                        to: 'PM',
                        toEmails: 'pm@example.com',
                        cc: 'Lead, SPM',
                        ccEmails: 'lead@example.com,spm@example.com',
                        draftMessage: `Hi [PM Name],

I received an email from a parent of [Student Name] [Student ID] from batch [Batch ID]. They are concerned about [briefly summarize the parent's email]. I have attached the email for your reference.

Please let me know how to proceed.

Thanks.`
                    },
                    {
                        id: 'students-joining-late-ipad-phone-1',
                        title: 'Students Joining Late with Ipad or Phone (sessions 1-12)',
                        description: 'For students joining late in the first 12 sessions.',
                        keywords: ['joining late', 'ipad', 'phone', 'sessions 1-12', 'access issue'],
                        to: 'Counsellor',
                        toEmails: 'counsellor@example.com',
                        cc: 'cc-team alias, PM, SPM, Lead',
                        ccEmails: 'ccteam@example.com,pm@example.com,spm@example.com,lead@example.com',
                        draftMessage: `Hi [Counsellor Name],

This is regarding [Student Name] [Student ID] from batch [Batch ID]. The student has been joining the sessions using an iPad/Phone and is unable to [mention the specific issue, e.g., "access the LMS," "use the required software"]. I have already informed the parent about this issue.

Could you please follow up with them to resolve this?

Thanks.`
                    },
                    {
                        id: 'students-joining-late-ipad-phone-2',
                        title: 'Students Joining Late with Ipad or Phone (sessions 13+)',
                        description: 'For students joining late from the 13th session onwards, or joining with an iPad or Phone.',
                        keywords: ['joining late', 'ipad', 'phone', 'sessions 13+', 'access issue'],
                        to: 'Akash chaudhary/jyoti',
                        toEmails: 'akashchaudhary@example.com,jyoti@example.com',
                        cc: 'cc-team alias, PM, SPM, Lead',
                        ccEmails: 'ccteam@example.com,pm@example.com,spm@example.com,lead@example.com',
                        draftMessage: `Hi [Akash Chaudhary/Jyoti Name],

This is regarding [Student Name] [Student ID] from batch [Batch ID]. The student has been joining the sessions using an iPad/Phone and is unable to [mention the specific issue, e.g., "access the LMS," "use the required software"]. I have already informed the parent about this issue.

Could you please follow up with them to resolve this?

Thanks.`
                    }
                ]
            },
            {
                category: 'Kit & Shipment Issues',
                borderColor: '#F97316', // Orange
                incidents: [
                    {
                        id: 'address-verification',
                        title: 'Address verification',
                        description: 'Not receiving OTP, changing address, parents not available in the session for confirmation, all the verification sessions are completed and still the address remains unconfirmed, paused students join the batch and we cannot verify the address due to the verification not being configured. Note: SPM to coordinate with the CC team or ECOM team to get the verification done. Please raise a ticket to vivek.j@moonpreneur.com for external address verification. Collect the address in the class and mention it in the ticket along with the batch ID and kit name (Confirm address tag resets when the batch changes or the wrong status is visible).',
                        keywords: ['address', 'verification', 'otp', 'change address', 'unconfirmed', 'kit delivery'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Lead, PM, chetan',
                        ccEmails: 'lead@example.com,pm@example.com,chetan@example.com',
                        draftMessage: `Hi [SPM Name],

Could you please verify the shipping address for [Student Name] [Student ID] in batch [Batch ID]? The address is [provide the full address].

Please let me know if there are any discrepancies.

Thanks.`
                    },
                    {
                        id: 'shipment-issues-entire-kit',
                        title: 'Shipment Issues (entire kit)',
                        description: 'The student did not receive the kit, and the unboxing session is approaching or has passed. Note: Ask for the tracking details.',
                        keywords: ['shipment', 'kit', 'not received', 'unboxing session', 'tracking details'],
                        to: 'Syed, Vivek Jadon',
                        toEmails: 'syed@example.com,vivekjadon@example.com',
                        cc: 'Lead, PM, SPM',
                        ccEmails: 'lead@example.com,pm@example.com,spm@example.com',
                        draftMessage: `Hi [Syed/Vivek Jadon Name],

This is to inform you that the kit for [Student Name] [Student ID] from batch [Batch ID] has not been delivered yet. The student needs the kit by [date].

Could you please look into this urgently and provide an update on the shipment status?

Thanks.`
                    },
                    {
                        id: 'shipment-issues-order-not-placed',
                        title: 'Shipment Issues (order not placed)',
                        description: 'The student did not receive the kit, and the unboxing session is approaching or has passed. The ECOM team says that the order is not placed. Note: SPM to initiate the shipment on an urgent basis. PG to collect the address promptly within the session.',
                        keywords: ['shipment', 'order not placed', 'ecom team', 'urgent shipment'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Lead, PM',
                        ccEmails: 'lead@example.com,pm@example.com',
                        draftMessage: `Hi [SPM Name],

This is to inform you that the kit for [Student Name] [Student ID] from batch [Batch ID] has not been delivered yet. The ECOM team has stated that the order was not placed. I have collected the address: [provide the full address].

Could you please initiate the shipment on an urgent basis?

Thanks.`
                    },
                    {
                        id: 'kits-held-at-courier-office',
                        title: 'Kits held at courier office (delays)',
                        description: 'The tracking link shows Kits held at courier office that is causing delay. Note: We can offer makeup sessions for practical testing of the missed session without a kit. (Only SPM to approve this).',
                        keywords: ['kit', 'held', 'courier', 'delays', 'tracking', 'makeup sessions'],
                        to: 'Syed, Vivek Jadon',
                        toEmails: 'syed@example.com,vivekjadon@example.com',
                        cc: 'Lead, PM, SPM',
                        ccEmails: 'lead@example.com,pm@example.com,spm@example.com',
                        draftMessage: `Hi [Syed/Vivek Jadon],

The kit for [Student Name] [Student ID] from batch [Batch ID] is being held at the courier office, causing delays.

Could you please look into this and provide an update?

Thanks.`
                    },
                    {
                        id: 'wrong-kit-address-duplicate',
                        title: 'Wrong kit/address/duplicate kits',
                        description: 'Wrong kit shipped, kit sent to the wrong address, or duplicate kits. Note: PM/SPM to take action and get the right shipment initiated. Take help from the CC team if needed.',
                        keywords: ['wrong kit', 'wrong address', 'duplicate kit', 'shipment initiated'],
                        to: 'Syed, Vivek Jadon',
                        toEmails: 'syed@example.com,vivekjadon@example.com',
                        cc: 'Lead, PM, SPM',
                        ccEmails: 'lead@example.com,pm@example.com,spm@example.com',
                        draftMessage: `Hi [Syed/Vivek Jadon Name],

This is to inform you that [a wrong kit was shipped/the kit was sent to the wrong address/a duplicate kit was received] for [Student Name] [Student ID] from batch [Batch ID].

Could you please take the necessary action to rectify this?

Thanks.`
                    },
                    {
                        id: 'kit-not-delivered-in-batch',
                        title: 'Kit not delivered in a complete batch',
                        description: 'None of the students in a batch has received the kit, and the kit unboxing session is approaching. Note: SPM to initiate the delivery and check the fault. Also, enable the revision/buffer session.',
                        keywords: ['kit not delivered', 'batch issue', 'unboxing', 'revision session'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Lead, PM',
                        ccEmails: 'lead@example.com,pm@example.com',
                        draftMessage: `Hi [SPM Name],

The kits for my batch [Batch ID] have not been delivered. Could you please initiate the delivery and check the fault? I would also like to request that a revision/buffer session be enabled.

Thanks.`
                    },
                    {
                        id: 'kit-delivered-parent-denies',
                        title: 'Kit delivered, parent denies',
                        description: 'The status in the tracking link shows the kit is delivered, but the customer is saying that they have not received any kit. Note: SPM to discuss this with a counselor or CC team, and discuss this with the customer, and investigate the problem with Syed/Vivek.',
                        keywords: ['kit delivered', 'parent denies', 'tracking link', 'investigate', 'counselor'],
                        to: 'SPM',
                        toEmails: 'spm@example.com',
                        cc: 'Lead, PM',
                        ccEmails: 'lead@example.com,pm@example.com',
                        draftMessage: `Hi [SPM Name],

The tracking shows that the kit for [Student Name] [Student ID] from batch [Batch ID] has been delivered, but the parent has informed me that they have not received it.

Could you please look into this and discuss it with the parent?

Thanks.`
                    },
                    {
                        id: 'parent-requested-shipment-hold',
                        title: 'Parent requested shipment hold',
                        description: 'Parents requesting to hold the shipment for some time (travelling).',
                        keywords: ['shipment hold', 'parent request', 'travelling'],
                        to: 'Syed, Vivek Jadon',
                        toEmails: 'syed@example.com,vivekjadon@example.com',
                        cc: 'Lead, PM, SPM',
                        ccEmails: 'lead@example.com,pm@example.com,spm@example.com',
                        draftMessage: `Hi [Syed/Vivek Jadon Name],

A parent from my batch [Batch ID] has requested to hold the shipment of the kit for [Student Name] [Student ID] as they are travelling.

Could you please hold the shipment until [date]?

Thanks.`
                    },
                    {
                        id: 'kit-on-hold-payment-issues',
                        title: 'Kit on hold due to payment issues',
                        description: 'Kit is kept on hold due to payment issues like customer has not paid for the enrolled course.',
                        keywords: ['kit on hold', 'payment issues', 'enrolled course'],
                        to: 'Akansha, counsellor',
                        toEmails: 'akansha@example.com,counsellor@example.com',
                        cc: 'Lead, PM, SPM',
                        ccEmails: 'lead@example.com,pm@example.com,spm@example.com',
                        draftMessage: `Hi [Akansha/Counsellor Name],

The kit for [Student Name] [Student ID] from batch [Batch ID] is on hold due to a payment issue.

Could you please look into this and get it resolved?

Thanks.`
                    }
                ]
            },
            {
                category: 'Kit Component Issues',
                borderColor: '#A78BFA', // Purple
                incidents: [
                    {
                        id: 'component-not-working',
                        title: 'Component not working',
                        description: 'If any component in the kit is not working, physically damaged, has factory issues, malfunctioning including the microcontroller, our internal boards, off-the-shelf components (LEDS, POT, SENSORS, other modules), or problems related to batteries (RF, IR remote, and car kit batteries). Note: Debugging team to decide on sessions, replacement, or student consultation.',
                        keywords: ['component not working', 'physically damaged', 'microcontroller', 'batteries', 'replacement'],
                        to: 'Debugging alias',
                        toEmails: 'debugging@example.com',
                        cc: 'PM, Lead, SPM',
                        ccEmails: 'pm@example.com,lead@example.com,spm@example.com',
                        draftMessage: `Hi Debugging Team,

I'm reporting an issue with the kit for [Student Name] [Student ID] in batch [Batch ID]. The component [name of the component] is either [explain the issue, e.g., "broken," "not working," "incorrect"]. The student is unable to proceed with the session.

Could you please arrange for a replacement?

Thanks.`
                    },
                    {
                        id: 'components-missing-unboxing',
                        title: 'Components missing during the kit unboxing session',
                        description: 'Some components are missing from the kit during the unboxing session. Note: PM/SPM to verify and approve the shipment of missing components.',
                        keywords: ['missing components', 'unboxing session', 'kit issues', 'approve shipment'],
                        to: 'syed, vivek',
                        toEmails: 'syed@example.com,vivek@example.com',
                        cc: 'SPM, PM, Lead, Saurabh',
                        ccEmails: 'spm@example.com,pm@example.com,lead@example.com,saurabh@example.com',
                        draftMessage: `Hi [syed/vivek Name],

During the unboxing session for [Student Name] [Student ID] from batch [Batch ID], we noticed that the following components were missing from the kit [Serial number of the kit]: [list the missing components].

Could you please arrange for these to be shipped as soon as possible?

Thanks.`
                    },
                    {
                        id: 'lost-the-components',
                        title: 'Lost the components',
                        description: 'A student has lost some components of their kit, or a customer claims a component was missing, but you know it was in the kit unboxing session. Note: Check the session recording to verify.',
                        keywords: ['lost components', 'missing', 'kit', 'session recording', 'replacement'],
                        to: 'PM',
                        toEmails: 'pm@example.com',
                        cc: 'SPM, Lead, cc-team',
                        ccEmails: 'spm@example.com,lead@example.com,ccteam@example.com',
                        draftMessage: `Hi [PM Name],

A student, [Student Name] [Student ID], from batch [Batch ID], has informed me that they have lost the following components: [list the lost components]. I have verified the kit unboxing session recording, and the component is verified by the student.

Can you please guide me on the process for a replacement?

Thanks.`
                    },
                    {
                        id: 'component-link-not-ordered',
                        title: 'Link provided for component, but Cx didnâ€™t order',
                        description: 'We provided the link to order the component to the customer, but the customer is not ordering, and the child suffers. Note: Ask the CC team rep to call the customer and remind them to order the component. PG can also ask the child to remind their parents to order the component whose link has already been shared by the CC team or PG previously via email.',
                        keywords: ['link provided', 'customer didn\'t order', 'component', 'reminder call'],
                        to: 'Jyoti or Akash',
                        toEmails: 'jyoti@example.com,akash@example.com',
                        cc: 'SPM, PM, Lead, CC team alias',
                        ccEmails: 'spm@example.com,pm@example.com,lead@example.com,ccteam@example.com',
                        draftMessage: `Hi [Jyoti or Akash's name],

A student [student name] [student ID] from my batch [Batch ID] is suffering because they have not ordered a replacement for a lost component. We have already provided the link to the customer.

Could you please have the CC team representative call the customer and remind them to order the component?

Thanks.`
                    }
                ]
            }
        ];
        // === END OF EDITABLE SECTION ===
        
        const incidentsContainer = document.getElementById('incidentsContainer');
        const incidentSearch = document.getElementById('incidentSearch');
        const searchLoading = document.getElementById('searchLoading');
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        let currentExpandedCategory = null;

        // Debounce function to prevent excessive API calls
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };

        // Function to get the full list of incidents or incidents from a specific category
        const getIncidentData = () => {
            if (currentExpandedCategory) {
                const expandedCategory = incidentsData.find(cat => cat.category.toLowerCase().replace(' ', '-') === currentExpandedCategory);
                return expandedCategory ? expandedCategory.incidents : [];
            } else {
                return incidentsData.flatMap(cat => cat.incidents);
            }
        };
        
        // This is the new, self-contained search logic
        const performLocalSearch = (searchTerm) => {
            const allIncidents = incidentsData.flatMap(cat => cat.incidents.map(inc => ({ ...inc, category: cat.category, borderColor: cat.borderColor })));
            const matchedIncidents = [];
            const processedKeywords = new Set();
        
            searchTerm.toLowerCase().split(' ').forEach(term => {
                if (term.length > 2) {
                    allIncidents.forEach(incident => {
                        const searchString = `${incident.title} ${incident.description} ${incident.keywords.join(' ')}`.toLowerCase();
                        if (searchString.includes(term) && !processedKeywords.has(incident.id)) {
                             // Assign a relevance score based on the number of matching keywords
                            const score = incident.keywords.filter(keyword => keyword.includes(term)).length;
                            matchedIncidents.push({ ...incident, score });
                            processedKeywords.add(incident.id);
                        }
                    });
                }
            });
            
            // Sort by score in descending order
            matchedIncidents.sort((a, b) => b.score - a.score);
            return matchedIncidents;
        };

        /**
         * Copies text to the clipboard and shows a confirmation message.
         * @param {string} text - The text to copy.
         */
        const copyToClipboard = (text) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            messageBox.classList.remove('opacity-0', 'translate-y-full');
            messageBox.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-full');
            }, 2500);
        };

        /**
         * Composes a new Gmail email with pre-filled fields.
         * @param {string} to - The 'To' recipient(s).
         * @param {string} cc - The 'CC' recipient(s).
         * @param {string} subject - The email subject.
         * @param {string} body - The email body text.
         */
        const composeEmail = (to, cc, subject, body) => {
            const mailtoLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&cc=${encodeURIComponent(cc)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
        };

        /**
         * Function to create a collapsed category card.
         * @param {Object} categoryData - The category data object.
         * @returns {HTMLElement} The created category card button element.
         */
        const createCategoryCardButton = (categoryData) => {
            const cardButton = document.createElement('div');
            cardButton.classList.add('category-card-button', 'bg-white', 'p-6', 'rounded-xl', 'shadow-lg', 'flex', 'items-center', 'justify-between');
            cardButton.style.borderColor = categoryData.borderColor;
            cardButton.setAttribute('data-category', categoryData.category.toLowerCase().replace(' ', '-'));
            cardButton.innerHTML = `
                <div class="flex-1">
                    <h2 class="text-2xl font-bold">${categoryData.category}</h2>
                    <ul class="text-gray-600 text-sm mt-2 space-y-1">
                        ${categoryData.incidents.map(inc => `<li>${inc.title}</li>`).join('')}
                    </ul>
                </div>
                <svg class="caret-icon w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            `;
            return cardButton;
        };
        
        /**
         * Function to create an incident card element.
         * @param {Object} incident - The incident data object.
         * @returns {HTMLElement} The created card element.
         */
        const createIncidentCard = (incident, categoryBorderColor) => {
            const card = document.createElement('div');
            card.classList.add('incident-card', 'bg-white', 'p-6', 'rounded-xl', 'shadow-lg');
            card.setAttribute('data-search-terms', `${incident.title} ${incident.description} ${incident.to} ${incident.cc}`.toLowerCase());
            card.setAttribute('data-incident-id', incident.id);
            
            // Set the border color based on the category's `borderColor` property
            if (categoryBorderColor) {
                card.style.borderLeftColor = categoryBorderColor;
            }
            
            card.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-2">${incident.title}</h3>
                <p class="text-gray-600 mb-4">${incident.description}</p>

                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                    <p class="font-semibold text-gray-700 mb-2">To: <span class="font-normal text-gray-600">${incident.to}</span></p>
                    <p class="font-semibold text-gray-700">CC: <span class="font-normal text-gray-600">${incident.cc}</span></p>
                </div>

                <div class="flex space-x-4">
                    <button class="copy-btn w-full text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:scale-105 transition-all bg-blue-500 hover:bg-blue-600">
                        Copy Draft Message
                    </button>
                    <button class="email-btn w-full text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:scale-105 transition-all bg-red-500 hover:bg-red-600">
                        Compose Email
                    </button>
                </div>
            `;

            // Get the buttons and add event listeners
            const copyButton = card.querySelector('.copy-btn');
            const emailButton = card.querySelector('.email-btn');
            
            // Build the subject line with a placeholder
            const subjectLine = `${incident.title}: [batch ID]`;

            copyButton.addEventListener('click', () => copyToClipboard(incident.draftMessage));
            emailButton.addEventListener('click', () => composeEmail(incident.toEmails, incident.ccEmails, subjectLine, incident.draftMessage));

            return card;
        };

        /**
         * Renders all incident cards to the container, grouped by category.
         */
        const renderIncidents = (filteredIncidents = null) => {
            const allIncidents = filteredIncidents ? filteredIncidents : incidentsData;
            
            incidentsContainer.innerHTML = '';
            
            allIncidents.forEach(categoryData => {
                // Create a wrapper for each category and its cards
                const categoryWrapper = document.createElement('div');
                categoryWrapper.classList.add('category-wrapper');

                // Create the category button and add its border color
                const categoryCardButton = createCategoryCardButton(categoryData);
                categoryCardButton.style.borderColor = categoryData.borderColor;
                categoryWrapper.appendChild(categoryCardButton);

                // Create the hidden container for incident cards for this category
                const cardsContainer = document.createElement('div');
                cardsContainer.classList.add('cards-container', 'p-6', 'grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-8');
                cardsContainer.style.display = 'none';
                cardsContainer.setAttribute('data-category', categoryData.category.toLowerCase().replace(' ', '-'));

                categoryData.incidents.forEach(incident => {
                    const card = createIncidentCard(incident, categoryData.borderColor);
                    cardsContainer.appendChild(card);
                });

                categoryWrapper.appendChild(cardsContainer);
                incidentsContainer.appendChild(categoryWrapper);

                categoryCardButton.addEventListener('click', () => {
                    const isOpen = cardsContainer.style.display === 'grid';
                    
                    // Close all other open categories
                    document.querySelectorAll('.cards-container').forEach(container => {
                        container.style.display = 'none';
                    });
                    document.querySelectorAll('.caret-icon').forEach(icon => {
                        icon.classList.remove('rotate');
                    });
                    document.querySelectorAll('.category-card-button').forEach(button => {
                        button.classList.remove('highlighted-category');
                        button.classList.remove('faded-category');
                    });

                    // Toggle the clicked category
                    if (!isOpen) {
                        cardsContainer.style.display = 'grid';
                        categoryCardButton.querySelector('.caret-icon').classList.add('rotate');
                        categoryCardButton.classList.add('highlighted-category');
                        categoryCardButton.style.borderColor = categoryData.borderColor;

                        // Fade other categories
                        document.querySelectorAll('.category-card-button').forEach(button => {
                            if (button !== categoryCardButton) {
                                button.classList.add('faded-category');
                            }
                        });
                        currentExpandedCategory = categoryData.category.toLowerCase().replace(' ', '-');
                    } else {
                        currentExpandedCategory = null;
                    }
                });
            });
        };
        
        const handleSearch = (searchTerm) => {
            const allIncidents = incidentsData.flatMap(cat => cat.incidents.map(inc => ({ ...inc, category: cat.category, borderColor: cat.borderColor })));
            
            // Filter incidents based on search term
            const matchedIncidents = allIncidents.filter(incident => {
                const searchString = `${incident.title} ${incident.description} ${incident.keywords.join(' ')}`.toLowerCase();
                return searchTerm.toLowerCase().split(' ').some(term => searchString.includes(term));
            });
            
            // Map the matched incidents back to their categories
            const matchedData = [];
            const processedCategories = new Set();
            matchedIncidents.forEach(incident => {
                const category = incidentsData.find(cat => cat.incidents.some(inc => inc.id === incident.id));
                if (category && !processedCategories.has(category.category)) {
                    matchedData.push({
                        category: category.category,
                        borderColor: category.borderColor,
                        incidents: category.incidents.filter(inc => matchedIncidents.some(mInc => mInc.id === inc.id))
                    });
                    processedCategories.add(category.category);
                }
            });

            // Re-render the UI with only the matched data
            if (matchedData.length > 0) {
                 renderIncidents(matchedData);
            } else {
                 const noResultsMessage = document.createElement('p');
                 noResultsMessage.classList.add('text-center', 'text-gray-500', 'mt-10');
                 noResultsMessage.textContent = 'No matching incidents found. Please try a different query.';
                 incidentsContainer.innerHTML = '';
                 incidentsContainer.appendChild(noResultsMessage);
            }

            // Apply highlight/fade logic after rendering
            const categoryButtons = document.querySelectorAll('.category-card-button');
            const allCategories = incidentsData.map(cat => cat.category.toLowerCase().replace(' ', '-'));
            const matchedCategoryNames = matchedData.map(cat => cat.category.toLowerCase().replace(' ', '-'));

            categoryButtons.forEach(button => {
                const categoryName = button.getAttribute('data-category');
                if (matchedCategoryNames.includes(categoryName)) {
                     button.classList.add('highlighted-category');
                     button.querySelector('.caret-icon').classList.add('rotate');
                } else {
                    if (allCategories.includes(categoryName)) {
                       button.classList.add('faded-category');
                    }
                }
            });

            const allCardsContainers = document.querySelectorAll('.cards-container');
            allCardsContainers.forEach(container => {
                const categoryName = container.getAttribute('data-category');
                 if (matchedCategoryNames.includes(categoryName)) {
                    container.style.display = 'grid';
                }
            });
        };
        
        // Event listener for the search input
        incidentSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm === '') {
                renderIncidents();
            } else {
                handleSearch(searchTerm);
            }
        });
        
        const toggleScrollButton = () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
                scrollToBottomBtn.style.opacity = '0';
                scrollToBottomBtn.classList.add('hidden');
            } else {
                scrollToBottomBtn.style.opacity = '1';
                scrollToBottomBtn.classList.remove('hidden');
            }
        };

        window.addEventListener('scroll', toggleScrollButton);
        window.addEventListener('resize', toggleScrollButton);
        scrollToBottomBtn.addEventListener('click', () => {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        });

        // Initial render of all incidents on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderIncidents();
            toggleScrollButton();
        });
    </script>
</body>
</html>
