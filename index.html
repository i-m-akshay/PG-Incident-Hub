<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG Incident Management</title>
    <!-- Tailwind CSS CDN for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .incident-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .incident-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        .email-button {
            transition: background-color 0.3s ease;
        }
        .email-button:hover {
            background-color: #ef4444;
        }
        .search-icon {
            filter: grayscale(100%);
            transition: filter 0.2s;
        }
        .search-icon:hover {
            filter: grayscale(0%);
        }
        .category-card-button {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, opacity 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        .category-card-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        .caret-icon {
            transition: transform 0.3s ease;
        }
        .caret-icon.rotate {
            transform: rotate(90deg);
        }
        /* New styles for highlighting and fading */
        .faded-category {
            opacity: 0.5;
        }
        .highlighted-category {
            background-color: #e2e8f0; /* A light blue-gray */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-3px);
            border: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header section with title and search bar -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-bold text-gray-800 mb-2">PG Incident Hub</h1>
            <p class="text-gray-500 text-lg">Your one-stop guide for handling all types of incidents.</p>
        </header>

        <!-- Search bar -->
        <div class="mb-10 flex justify-center">
            <div class="relative w-full max-w-2xl">
                <input type="text" id="incidentSearch" placeholder="Search for an incident..." class="w-full pl-12 pr-4 py-3 rounded-full border-2 border-gray-300 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-md text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>
        </div>

        <!-- Incidents container -->
        <div id="incidentsContainer" class="space-y-8">
            <!-- All content will be dynamically generated here by JavaScript -->
        </div>
    </div>

    <!-- Message box for copy confirmation -->
    <div id="messageBox" class="fixed bottom-6 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transform translate-y-full transition-all duration-500 z-50">
        Message copied to clipboard!
    </div>

    <script>
        // === START OF EDITABLE SECTION ===
        // This is the array of all incidents, now structured with categories.
        const incidentsData = [
            {
                category: 'Upsell',
                incidents: [
                    {
                        id: 'upsell-tier-completion',
                        title: 'Tier Completion (after session 47)',
                        description: 'When your batch is about to complete TIER (at session number 47)',
                        to: 'LTV Counsellor',
                        cc: 'LTV alias, Lead , preeti, akansha negi, PM, Roshan',
                        draftMessage: `Hi [LTV counselor name],

The [batch ID] batch requires an upsell. There are a total of [no. of students] students in this batch.
Currently, they are in [Tier, Stage, Session]. Please do the needful and let me know if you need any other information.

Best regards,
[PG's Name]`
                    },
                    {
                        id: 'upsell-parent-concern',
                        title: 'Parents\' concern after upsell',
                        description: 'Parent expresses that the child is upsold in the wrong tier, has problems with the curriculum and syllabus. Expectation of the parents is not met in the upsold tier (might come up mid-tier as well), or in case of evaluation',
                        to: 'PM, SPM',
                        cc: 'Lead, Anurag, Roshan',
                        draftMessage: `Hi [PM/SPM name],

The parent of the student [customer ID] [student name] in the batch [batch ID] joined the recent session to inform that [concern in brief with all the important details mentioned by the parent].

Please look into this.

Best regards,
[PG's Name]`
                    },
                    {
                        id: 'upsell-absent-1-2',
                        title: 'Absenteeism in upsell batch (sessions 1-2)',
                        description: 'The student did not join for the first two sessions.',
                        to: 'Counsellor',
                        cc: 'Lead, ltv, PM, Roshan',
                        draftMessage: `Hi [counselor name],

This is to inform you that student [student ID] [student name] has been absent for 2 consecutive sessions (Sessions 1 and 2) of Tier [Tier, stage].
Can you please look into this and take the necessary steps?
Batch Name: [batch ID]
Student: [student name] [student ID]

Best regards,
[PG's Name]`
                    },
                    {
                        id: 'upsell-absent-1-4',
                        title: 'Absenteeism in upsell batch (sessions 1-4)',
                        description: 'The student did not join for the first four sessions. NOTE: SPM to ask ushma to mark as course completed and inform LTV',
                        to: 'PM/SPM',
                        cc: 'Lead, ltv, PM, Roshan',
                        draftMessage: `Hi [PM/SPM name],

This is to inform you that student [student ID] [student name] has been absent for 4 consecutive sessions (Sessions 1 to 4) of Tier [Tier, stage].
Can you please look into this and take the necessary steps?
Batch Name: [batch ID]
Student: [student name] [student ID]

Best regards,
[PG's Name]`
                    }
                ]
            },
            {
                category: 'Pause related',
                incidents: [
                    {
                        id: 'pause-related-parent-informed',
                        title: 'Parent informed',
                        description: 'Parents informed in the class that the child will be going on a pause. NOTE: PG should get the info whenever a student joins back after a pause. PG to confirm from the student about the kit (PG to get trained on how to apply for pause on LMS)',
                        to: 'jyoti/akash chaudhary',
                        cc: 'Lead, cc-team@moonpreneur.com',
                        draftMessage: `Hi [Jyoti/Akash],

The parent of the student [customer ID] [student name] in the batch [batch ID] joined the recent session and informed that [mention the reason] [Date from: To]. Please confirm with the parent again and mark the student as paused.

Best regards,
[PG's Name]`
                    }
                ]
            }
        ];
        // === END OF EDITABLE SECTION ===

        const incidentsContainer = document.getElementById('incidentsContainer');
        const incidentSearch = document.getElementById('incidentSearch');
        const messageBox = document.getElementById('messageBox');

        /**
         * Function to create a collapsed category card.
         * @param {Object} categoryData - The category data object.
         * @returns {HTMLElement} The created category card button element.
         */
        const createCategoryCardButton = (categoryData) => {
            const cardButton = document.createElement('div');
            cardButton.classList.add('category-card-button', 'bg-white', 'p-6', 'rounded-xl', 'shadow-lg', 'flex', 'items-center', 'justify-between');
            cardButton.setAttribute('data-category', categoryData.category.toLowerCase().replace(' ', '-'));
            cardButton.innerHTML = `
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-gray-800">${categoryData.category}</h2>
                    <ul class="text-gray-600 text-sm mt-2 space-y-1">
                        ${categoryData.incidents.map(inc => `<li>${inc.title}</li>`).join('')}
                    </ul>
                </div>
                <svg class="caret-icon w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            `;
            return cardButton;
        };
        
        /**
         * Function to create an incident card element.
         * @param {Object} incident - The incident data object.
         * @returns {HTMLElement} The created card element.
         */
        const createIncidentCard = (incident) => {
            const card = document.createElement('div');
            card.classList.add('incident-card', 'bg-white', 'p-6', 'rounded-xl', 'shadow-lg', 'border-t-4', 'border-red-500');
            card.setAttribute('data-search-terms', `${incident.title} ${incident.description} ${incident.to} ${incident.cc}`.toLowerCase());
            card.setAttribute('data-incident-id', incident.id);

            card.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-2">${incident.title}</h3>
                <p class="text-gray-600 mb-4">${incident.description}</p>

                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                    <p class="font-semibold text-gray-700 mb-2">To: <span class="font-normal text-gray-600">${incident.to}</span></p>
                    <p class="font-semibold text-gray-700">CC: <span class="font-normal text-gray-600">${incident.cc}</span></p>
                </div>

                <div class="flex space-x-4">
                    <button class="copy-btn w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                        Copy Draft Message
                    </button>
                    <button class="email-btn w-full bg-red-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-600 transition-colors">
                        Compose Email
                    </button>
                </div>
            `;

            // Get the buttons and add event listeners
            const copyButton = card.querySelector('.copy-btn');
            const emailButton = card.querySelector('.email-btn');

            copyButton.addEventListener('click', () => copyToClipboard(incident.draftMessage));
            emailButton.addEventListener('click', () => composeEmail(incident.to, incident.cc, incident.draftMessage));

            return card;
        };

        /**
         * Renders all incident cards to the container, grouped by category.
         */
        const renderIncidents = () => {
            incidentsContainer.innerHTML = '';
            
            // Container for category card buttons to be in a row
            const categoryButtonsContainer = document.createElement('div');
            categoryButtonsContainer.id = 'categoryButtonsContainer';
            categoryButtonsContainer.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-8');
            incidentsContainer.appendChild(categoryButtonsContainer);

            // Container for all expanded incident cards, to be displayed below the category buttons
            const expandedCardsContainer = document.createElement('div');
            expandedCardsContainer.id = 'expandedCardsContainer';
            expandedCardsContainer.classList.add('mt-8');
            incidentsContainer.appendChild(expandedCardsContainer);

            incidentsData.forEach(categoryData => {
                // Create the category button and add it to its container
                const categoryCardButton = createCategoryCardButton(categoryData);
                categoryButtonsContainer.appendChild(categoryCardButton);

                // Create the hidden container for incident cards for this category
                const cardsContainer = document.createElement('div');
                cardsContainer.classList.add('cards-container', 'p-6', 'grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-8');
                cardsContainer.style.display = 'none';
                cardsContainer.setAttribute('data-category', categoryData.category.toLowerCase().replace(' ', '-'));

                categoryData.incidents.forEach(incident => {
                    const card = createIncidentCard(incident);
                    cardsContainer.appendChild(card);
                });

                expandedCardsContainer.appendChild(cardsContainer);

                categoryCardButton.addEventListener('click', () => {
                    const isOpen = cardsContainer.style.display === 'grid';
                    
                    // Reset all categories to a default state (close and remove highlights)
                    document.querySelectorAll('.cards-container').forEach(container => {
                        container.style.display = 'none';
                    });
                    document.querySelectorAll('.caret-icon').forEach(icon => {
                        icon.classList.remove('rotate');
                    });
                    document.querySelectorAll('.category-card-button').forEach(button => {
                        button.classList.remove('highlighted-category');
                        button.classList.remove('faded-category');
                    });

                    // Toggle the clicked category
                    if (!isOpen) {
                        cardsContainer.style.display = 'grid';
                        categoryCardButton.querySelector('.caret-icon').classList.add('rotate');
                        categoryCardButton.classList.add('highlighted-category');

                        // Fade other categories
                        document.querySelectorAll('.category-card-button').forEach(button => {
                            if (button !== categoryCardButton) {
                                button.classList.add('faded-category');
                            }
                        });
                    }
                });
            });
        };

        /**
         * Copies text to the clipboard and shows a confirmation message.
         * @param {string} text - The text to copy.
         */
        const copyToClipboard = (text) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            messageBox.classList.remove('opacity-0', 'translate-y-full');
            messageBox.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-full');
            }, 2500);
        };

        /**
         * Composes a new Gmail email with pre-filled fields.
         * @param {string} to - The 'To' recipient(s).
         * @param {string} cc - The 'CC' recipient(s).
         * @param {string} body - The email body text.
         */
        const composeEmail = (to, cc, body) => {
            // URL-encode the email body and subject
            const subject = encodeURIComponent(`Incident Report: `);
            const mailtoLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(to)}&cc=${encodeURIComponent(cc)}&su=${subject}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink, '_blank');
        };

        // Event listener for the search input
        incidentSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const categoryButtonsContainer = document.getElementById('categoryButtonsContainer');
            const expandedCardsContainer = document.getElementById('expandedCardsContainer');
            
            // Clear both containers to rebuild the view
            categoryButtonsContainer.innerHTML = '';
            expandedCardsContainer.innerHTML = '';

            incidentsData.forEach(categoryData => {
                const filteredIncidents = categoryData.incidents.filter(incident => 
                    `${incident.title} ${incident.description} ${incident.to} ${incident.cc}`.toLowerCase().includes(searchTerm)
                );
                
                if (filteredIncidents.length > 0 || searchTerm === '') {
                    // Create and append category button
                    const categoryCardButton = createCategoryCardButton(categoryData);
                    categoryButtonsContainer.appendChild(categoryCardButton);

                    // Create and append the cards container for filtered incidents
                    const cardsContainer = document.createElement('div');
                    cardsContainer.classList.add('cards-container', 'p-6', 'grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-8');
                    cardsContainer.style.display = 'none';
                    cardsContainer.setAttribute('data-category', categoryData.category.toLowerCase().replace(' ', '-'));

                    filteredIncidents.forEach(incident => {
                        const card = createIncidentCard(incident);
                        cardsContainer.appendChild(card);
                    });
                    expandedCardsContainer.appendChild(cardsContainer);
                    
                    if (searchTerm !== '') {
                        cardsContainer.style.display = 'grid';
                        categoryCardButton.querySelector('.caret-icon').classList.add('rotate');
                    }
                    
                    // Add the event listener for the button
                    categoryCardButton.addEventListener('click', () => {
                        const isOpen = cardsContainer.style.display === 'grid';
                        
                        document.querySelectorAll('.cards-container').forEach(container => {
                            container.style.display = 'none';
                        });
                        document.querySelectorAll('.caret-icon').forEach(icon => {
                            icon.classList.remove('rotate');
                        });

                        if (!isOpen) {
                            cardsContainer.style.display = 'grid';
                            categoryCardButton.querySelector('.caret-icon').classList.add('rotate');
                        }
                    });
                }
            });
            
            if (searchTerm !== '') {
                expandedCardsContainer.classList.remove('mt-8');
            } else {
                expandedCardsContainer.classList.add('mt-8');
            }
        });

        // Initial render of all incidents on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderIncidents();
        });
    </script>
</body>
</html>
